<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Budget Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar style for transactions list */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        /* Style for the button bubbles */
        .bubble-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .bubble-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 md:p-8 flex flex-col items-center">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">My Budget Hub</h1>
        <p class="text-gray-600 mb-8">Track your money flow in real-time.</p>

        <!-- Loading Spinner and Error Message -->
        <div id="loading-indicator" class="text-center p-6 bg-white rounded-xl shadow-lg transition-opacity duration-300">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-indigo-600 font-medium">Initializing Database...</p>
        </div>
        <p id="error-message" class="text-red-600 font-semibold mt-4 hidden"></p>

        <!-- Main Content Area -->
        <div id="main-content" class="w-full max-w-4xl opacity-0 transition-opacity duration-500 hidden">
            <!-- Header and Balance -->
            <div class="bg-white p-6 rounded-2xl shadow-xl mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <p class="text-lg font-medium text-gray-500">Current Balance</p>
                    <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                        <label for="currency-select" class="text-sm text-gray-700">Currency:</label>
                        <select id="currency-select" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="saveCurrency()">
                            <option value="$">$ (USD)</option>
                            <option value="€">€ (EUR)</option>
                            <option value="£">£ (GBP)</option>
                            <option value="¥">¥ (JPY/CNY)</option>
                            <option value="₹">₹ (INR)</option>
                            <option value="A$">A$ (AUD)</option>
                            <!-- NEW: Added UAE Dirham -->
                            <option value="د.إ">د.إ (AED)</option>
                        </select>
                    </div>
                </div>
                <p id="current-balance" class="text-5xl font-extrabold text-gray-900 transition-colors duration-500">$0.00</p>
                <p class="text-xs text-gray-400 mt-2">User ID: <span id="user-id-display" class="font-mono text-sm">...</span></p>
            </div>

            <!-- Transaction Input Forms -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

                <!-- Income Input Card -->
                <div class="bg-green-50 border-2 border-green-200 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-green-700 mb-4">Add Income</h2>
                    <form id="income-form" onsubmit="handleTransaction(event, 'income')">
                        <input type="hidden" name="category" value="Income">

                        <div class="mb-4">
                            <label for="income-description" class="block text-sm font-medium text-gray-700">Source / Description</label>
                            <input type="text" id="income-description" name="description" required placeholder="Salary, Gift, Freelance Job" class="mt-1 block w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-green-500 focus:border-green-500">
                        </div>

                        <div class="mb-4">
                            <label for="income-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <div class="relative mt-1 rounded-xl shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span id="income-currency-symbol" class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <!-- FIX: Changed type to 'text' and added inputmode/pattern for better cross-locale input -->
                                <input type="text" id="income-amount" name="amount" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]+" required placeholder="500.00" class="block w-full pl-7 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                            </div>
                            <p id="income-error" class="text-sm text-red-500 mt-1 hidden font-medium">Please enter a valid positive number (e.g., 100.00 or 100,00).</p>
                        </div>

                        <button type="submit" class="bubble-btn w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 shadow-md shadow-green-300">
                            + Record Income
                        </button>
                    </form>
                </div>

                <!-- Expense Input Card -->
                <div class="bg-red-50 border-2 border-red-200 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold text-red-700 mb-4">Add Expense</h2>
                    <form id="expense-form" onsubmit="handleTransaction(event, 'expense')">
                        <div class="mb-4">
                            <label for="expense-description" class="block text-sm font-medium text-gray-700">Item / Description</label>
                            <input type="text" id="expense-description" name="description" required placeholder="Groceries, Rent, Coffee" class="mt-1 block w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>

                        <div class="mb-4">
                            <label for="expense-category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="expense-category" name="category" required class="mt-1 block w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-red-500 focus:border-red-500">
                                <option value="" disabled selected>Select Category</option>
                                <option value="Bills">Bills (Rent, Utilities)</option>
                                <option value="Leisure">Leisure (Fun, Hobbies)</option>
                                <option value="Food">Food (Groceries, Dining)</option>
                                <option value="Transport">Transport (Gas, Transit)</option>
                                <option value="Health">Health / Wellness</option>
                                <option value="Other">Other Spendage</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <div class="relative mt-1 rounded-xl shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span id="expense-currency-symbol" class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <!-- FIX: Changed type to 'text' and added inputmode/pattern for better cross-locale input -->
                                <input type="text" id="expense-amount" name="amount" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]+" required placeholder="25.50" class="block w-full pl-7 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-red-500 focus:border-red-500">
                            </div>
                            <p id="expense-error" class="text-sm text-red-500 mt-1 hidden font-medium">Please enter a valid positive number (e.g., 25.50 or 25,50).</p>
                        </div>

                        <button type="submit" class="bubble-btn w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 shadow-md shadow-red-300">
                            - Record Expense
                        </button>
                    </form>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Transaction History</h2>
                <div id="transactions-list" class="space-y-3 custom-scroll max-h-96 overflow-y-auto p-2">
                    <!-- Transactions will be rendered here -->
                    <p class="text-center text-gray-500 p-4" id="no-transactions-message">No transactions recorded yet. Add your first income or expense!</p>
                </div>
            </div>

            <!-- Custom Modal for Delete Confirmation -->
            <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-xl font-bold text-red-600 mb-4">Confirm Deletion</h3>
                    <p id="modal-text" class="text-gray-700 mb-6">Are you sure you want to delete this transaction?</p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">Cancel</button>
                        <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, serverTimestamp, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & CONSTANTS ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-budget-app';

        let app, db, auth;
        let userId = null;
        let currentCurrency = '$';
        let transactions = [];

        // UI Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainContent = document.getElementById('main-content');
        const errorMessage = document.getElementById('error-message');
        const currentBalanceEl = document.getElementById('current-balance');
        const transactionsListEl = document.getElementById('transactions-list');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // Firestore paths utility
        const getPrivatePath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}`;
        const getSettingsDocRef = () => doc(db, getPrivatePath('settings'), 'user_preferences');

        // --- AUTHENTICATION & INITIALIZATION ---
        window.initializeAppData = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Running in mock mode.");
                errorMessage.textContent = "Error: Firebase configuration is missing. Cannot save data.";
                errorMessage.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainContent.classList.add('opacity-100');
                return;
            }

            try {
                // Set Firestore logging for debugging
                setLogLevel('Debug');

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Authenticate User
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Wait for Auth state to be ready
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        // 3. Load Settings (Currency)
                        loadCurrency().then(() => {
                            // 4. Start Real-time Listeners
                            startTransactionListener();

                            // 5. Hide Loading, Show Content
                            loadingIndicator.classList.add('hidden');
                            mainContent.classList.remove('hidden');
                            setTimeout(() => mainContent.classList.add('opacity-100'), 50); // Small delay for transition
                        });

                    } else {
                        console.error("Authentication failed.");
                        errorMessage.textContent = "Error: Failed to authenticate user.";
                        errorMessage.classList.remove('hidden');
                        loadingIndicator.classList.add('hidden');
                    }
                });

            } catch (e) {
                console.error("Initialization error:", e);
                errorMessage.textContent = `Error during initialization: ${e.message}`;
                errorMessage.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
            }
        };

        // --- CURRENCY HANDLING ---

        window.updateCurrencyDisplay = () => {
            document.querySelectorAll('[id$="-currency-symbol"]').forEach(el => {
                el.textContent = currentCurrency;
            });
            document.getElementById('currency-select').value = currentCurrency;
            updateBalanceAndDisplay();
        };

        const loadCurrency = async () => {
            const settingsRef = getSettingsDocRef();
            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    currentCurrency = docSnap.data().currencySymbol || '$';
                }
                updateCurrencyDisplay();
            } catch (e) {
                console.warn("Could not load currency settings, using default '$'.", e);
                updateCurrencyDisplay();
            }
        };

        window.saveCurrency = async () => {
            const newCurrency = document.getElementById('currency-select').value;
            currentCurrency = newCurrency;
            updateCurrencyDisplay();
            const settingsRef = getSettingsDocRef();
            try {
                await setDoc(settingsRef, { currencySymbol: newCurrency }, { merge: true });
                console.log("Currency saved successfully.");
            } catch (e) {
                console.error("Error saving currency:", e);
                // Show a temporary error message in UI if needed
            }
        };


        // --- TRANSACTION LOGIC (CRUD) ---

        const startTransactionListener = () => {
            const q = query(collection(db, getPrivatePath('transactions')));
            // Listen for real-time updates
            onSnapshot(q, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort transactions by timestamp descending
                transactions.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderTransactions();
                updateBalanceAndDisplay();
            }, (error) => {
                console.error("Error listening to transactions:", error);
                errorMessage.textContent = "Error fetching transactions: " + error.message;
                errorMessage.classList.remove('hidden');
            });
        };

        window.handleTransaction = async (event, type) => {
            event.preventDefault();

            const form = event.target;
            const errorElementId = type === 'income' ? 'income-error' : 'expense-error';
            const errorElement = document.getElementById(errorElementId);
            
            // Hide previous error
            errorElement.classList.add('hidden');
            
            const description = form.elements.description.value.trim();
            
            // FIX: Use type="text" and robust parsing. Replace comma with period for universal parseFloat recognition.
            let amountString = form.elements.amount.value.trim().replace(',', '.');
            const amount = parseFloat(amountString);
            
            const category = form.elements.category ? form.elements.category.value : type;

            if (isNaN(amount) || amount <= 0 || !description) {
                // This client-side check is the final validation for a positive amount
                console.error("Invalid input: Amount must be a positive number.");
                
                // Only show error for amount if it's the issue (description uses native 'required' tooltip)
                if (isNaN(amount) || amount <= 0) {
                    errorElement.classList.remove('hidden');
                }
                return;
            }

            try {
                await addDoc(collection(db, getPrivatePath('transactions')), {
                    type: type, // 'income' or 'expense'
                    description: description,
                    category: category,
                    amount: amount,
                    timestamp: serverTimestamp(),
                });

                // Clear the form on success
                form.reset();
            } catch (e) {
                console.error("Error adding transaction:", e);
                // NOTE: Use a temporary UI message instead of alert in production
                alert(`Failed to save transaction: ${e.message}`); 
            }
        };

        window.deleteTransaction = (id) => {
            // Use the global modal to confirm before deleting
            window.openDeleteModal(id);
        };

        window.executeDelete = async (id) => {
            window.closeDeleteModal();
            try {
                const docRef = doc(db, getPrivatePath('transactions'), id);
                await deleteDoc(docRef);
                console.log("Transaction deleted:", id);
            } catch (e) {
                console.error("Error deleting transaction:", e);
                // NOTE: Use a temporary UI message instead of alert in production
                alert(`Failed to delete transaction: ${e.message}`);
            }
        };


        // --- UI RENDERING ---

        window.updateBalanceAndDisplay = () => {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = totalIncome - totalExpense;

            currentBalanceEl.textContent = `${currentCurrency}${balance.toFixed(2)}`;
            currentBalanceEl.className = `text-5xl font-extrabold transition-colors duration-500 ${balance < 0 ? 'text-red-600' : 'text-green-600'}`;
        };

        const renderTransactions = () => {
            transactionsListEl.innerHTML = ''; // Clear existing list

            if (transactions.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
                return;
            } else {
                noTransactionsMessage.classList.add('hidden');
            }

            transactions.forEach(t => {
                const isIncome = t.type === 'income';
                const sign = isIncome ? '+' : '-';
                const color = isIncome ? 'text-green-700 bg-green-50' : 'text-red-700 bg-red-50';
                const borderColor = isIncome ? 'border-green-300' : 'border-red-300';
                const formattedAmount = `${sign}${currentCurrency}${Math.abs(t.amount).toFixed(2)}`;
                const categoryText = isIncome ? 'Income' : t.category;

                const date = t.timestamp ? new Date(t.timestamp.toMillis()) : new Date();
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                const itemHtml = `
                    <div class="flex items-center justify-between p-4 border-l-4 ${borderColor} ${color} rounded-xl shadow-sm transition hover:shadow-md">
                        <div class="flex flex-col sm:flex-row sm:items-center w-full">
                            <div class="flex-grow">
                                <p class="font-semibold text-lg truncate">${t.description}</p>
                                <p class="text-xs text-gray-500 mt-0.5"><span class="font-medium">${categoryText}</span> • ${formattedDate}</p>
                            </div>
                            <p class="font-bold text-xl mt-2 sm:mt-0 sm:ml-4 flex-shrink-0">${formattedAmount}</p>
                        </div>
                        <button onclick="deleteTransaction('${t.id}')" class="ml-4 p-2 text-gray-400 hover:text-red-500 rounded-full transition duration-150 flex-shrink-0">
                            <!-- Trash icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionsListEl.insertAdjacentHTML('beforeend', itemHtml);
            });
        };

        // --- MODAL LOGIC ---
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        window.openDeleteModal = (transactionId) => {
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
            confirmDeleteBtn.onclick = () => executeDelete(transactionId);
        };

        window.closeDeleteModal = () => {
            deleteModal.classList.remove('flex');
            deleteModal.classList.add('hidden');
            confirmDeleteBtn.onclick = null; // Clear handler
        };

        // Initialize App on load
        window.onload = initializeAppData;

    </script>
</body>
</html>
