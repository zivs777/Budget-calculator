import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, addDoc, onSnapshot, orderBy } from 'firebase/firestore';
import { Wallet, ArrowUp, ArrowDown, PiggyBank, Receipt, DollarSign, Calendar, Tag, Clipboard, Loader2, User, Globe } from 'lucide-react';

// --- Global Variable Declarations (Mandatory) ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'budget-app-default-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Available Currency Options
const CURRENCIES = {
    AED: { code: 'AED', symbol: 'د.إ', locale: 'ar-AE' },
    USD: { code: 'USD', symbol: '$', locale: 'en-US' },
    EUR: { code: 'EUR', symbol: '€', locale: 'en-GB' },
};

// Helper to format currency (Updated to accept currency parameters)
const formatCurrency = (amount, currencyCode, locale) => {
    return new Intl.NumberFormat(locale, {
        style: 'currency',
        currency: currencyCode,
        minimumFractionDigits: 2,
    }).format(amount);
};

// Available categories for expenses and incomes
const CATEGORIES = {
    expense: ['Bills', 'Food', 'Leisure', 'Transport', 'Shopping', 'Health', 'Other'],
    income: ['Salary', 'Gift', 'Investment', 'Other'],
};

// Main App Component
const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [authReady, setAuthReady] = useState(false);
    const [transactions, setTransactions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');
    
    // State for selected currency, defaulting to AED (Dirhams)
    const [currency, setCurrency] = useState(CURRENCIES.AED); 

    const [newTransaction, setNewTransaction] = useState({
        type: 'expense',
        amount: '',
        category: CATEGORIES.expense[0],
        description: '',
    });

    // 1. Initialize Firebase and Handle Authentication
    useEffect(() => {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize app.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);
            
            setDb(firestore);
            setAuth(firebaseAuth);

            // Authentication listener
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setAuthReady(true);
                    console.log("Authenticated user ID:", user.uid);
                } else if (!user && !authReady) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in if no token is provided
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (e) {
                        console.error("Error signing in:", e);
                        setUserId(crypto.randomUUID());
                        setAuthReady(true);
                    }
                }
            });

            return () => unsubscribe();
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }
    }, [authReady]);

    // 2. Real-time Transaction Listener (onSnapshot)
    useEffect(() => {
        if (db && userId) {
            setLoading(true);
            setError('');
            
            // Private data path: /artifacts/{appId}/users/{userId}/transactions
            const collectionPath = `artifacts/${appId}/users/${userId}/transactions`;
            const q = query(collection(db, collectionPath), orderBy('timestamp', 'desc'));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    amount: Number(doc.data().amount) // Ensure amount is a number
                }));
                setTransactions(fetchedTransactions);
                setLoading(false);
            }, (err) => {
                console.error("Firestore snapshot error:", err);
                setError("Failed to load transactions. Please check console for details.");
                setLoading(false);
            });

            return () => unsubscribe();
        }
    }, [db, userId]);

    // 3. Calculate Balance and Metrics
    const { balance, totalIncome, totalExpenses } = useMemo(() => {
        let income = 0;
        let expenses = 0;
        transactions.forEach(t => {
            if (t.type === 'income') {
                income += t.amount;
            } else {
                expenses += t.amount;
            }
        });
        return {
            balance: income - expenses,
            totalIncome: income,
            totalExpenses: expenses,
        };
    }, [transactions]);

    // 4. Handle Form Changes
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setNewTransaction(prev => ({ ...prev, [name]: value }));
    };

    const handleTypeChange = (newType) => {
        const defaultCategory = CATEGORIES[newType][0];
        setNewTransaction(prev => ({
            ...prev,
            type: newType,
            category: defaultCategory,
        }));
    };

    // 5. Submit Transaction
    const addTransaction = async (e) => {
        e.preventDefault();
        
        const amountValue = parseFloat(newTransaction.amount);

        if (isNaN(amountValue) || amountValue <= 0) {
            setError("Please enter a valid amount greater than zero.");
            return;
        }

        if (!newTransaction.description.trim()) {
             setError("Please add a description.");
             return;
        }

        if (!db || !userId) {
            setError("Database not ready. Please wait.");
            return;
        }

        setError('');

        const transactionData = {
            ...newTransaction,
            amount: amountValue,
            timestamp: Date.now(),
        };
        
        try {
            const collectionPath = `artifacts/${appId}/users/${userId}/transactions`;
            await addDoc(collection(db, collectionPath), transactionData);
            
            // Reset form fields after successful submission
            setNewTransaction({
                type: 'expense',
                amount: '',
                category: CATEGORIES.expense[0],
                description: '',
            });

        } catch (e) {
            console.error("Error adding document: ", e);
            setError("Failed to save transaction. Please try again.");
        }
    };

    // --- Helper Components for UI ---

    const StatsCard = ({ title, amount, icon: Icon, isBalance }) => (
        <div className={`p-5 rounded-xl shadow-lg ${isBalance ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800'}`}>
            <div className="flex items-center justify-between">
                <h3 className={`text-lg font-semibold ${isBalance ? 'text-indigo-200' : 'text-gray-500'}`}>{title}</h3>
                <Icon className={`w-6 h-6 ${isBalance ? 'text-indigo-300' : (title.includes('Income') ? 'text-green-500' : 'text-red-500')}`} />
            </div>
            <p className={`mt-2 text-3xl font-bold ${isBalance ? 'text-white' : 'text-gray-800'}`}>
                {formatCurrency(amount, currency.code, currency.locale)}
            </p>
        </div>
    );

    const TransactionItem = ({ type, amount, description, category, timestamp }) => {
        const isIncome = type === 'income';
        const colorClass = isIncome ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
        const sign = isIncome ? '+' : '-';
        const Icon = isIncome ? ArrowUp : ArrowDown;

        const date = new Date(timestamp).toLocaleDateString();

        return (
            <div className="flex justify-between items-center py-4 border-b last:border-b-0">
                <div className="flex items-center space-x-3">
                    <div className={`p-2 rounded-full ${colorClass}`}>
                        <Icon className="w-5 h-5" />
                    </div>
                    <div>
                        <p className="font-semibold text-gray-800 capitalize">{description || category}</p>
                        <p className="text-sm text-gray-500 flex items-center mt-1">
                            <Tag className="w-3 h-3 mr-1" />
                            {category}
                            <span className="mx-2 text-xs">•</span>
                            <Calendar className="w-3 h-3 mr-1" />
                            {date}
                        </p>
                    </div>
                </div>
                <div className="text-right">
                    <p className={`font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}`}>
                        {sign}{formatCurrency(amount, currency.code, currency.locale)}
                    </p>
                </div>
            </div>
        );
    };

    // --- Main Render ---

    return (
        <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-inter">
            <script src="https://cdn.tailwindcss.com"></script>
            <style>
                {`
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
                    .font-inter { font-family: 'Inter', sans-serif; }
                `}
            </style>
            
            <div className="max-w-4xl mx-auto">
                <header className="text-center mb-10">
                    <h1 className="text-4xl font-extrabold text-gray-900 flex items-center justify-center">
                        <PiggyBank className="w-8 h-8 mr-3 text-indigo-600" />
                        Budget Tracker
                    </h1>
                    
                    <div className="flex justify-center items-center mt-2 text-gray-500">
                        <p className="text-sm mr-4">User ID: <span className="font-mono text-xs p-1 bg-gray-200 rounded">{userId || 'Loading...'}</span></p>

                        {/* Currency Selector */}
                        <div className="flex items-center text-sm">
                            <Globe className="w-4 h-4 mr-1 text-indigo-500" />
                            <select
                                value={currency.code}
                                onChange={(e) => setCurrency(CURRENCIES[e.target.value])}
                                className="p-1 border border-gray-300 rounded-lg text-sm bg-white focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer"
                            >
                                {Object.values(CURRENCIES).map(c => (
                                    <option key={c.code} value={c.code}>{c.code} ({c.symbol})</option>
                                ))}
                            </select>
                        </div>
                    </div>
                </header>

                {error && (
                    <div className="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg shadow-md" role="alert">
                        {error}
                    </div>
                )}
                
                {/* Balance & Stats Summary */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <StatsCard 
                        title="Current Balance" 
                        amount={balance} 
                        icon={Wallet} 
                        isBalance={true}
                    />
                    <StatsCard 
                        title="Total Income" 
                        amount={totalIncome} 
                        icon={ArrowUp} 
                    />
                    <StatsCard 
                        title="Total Expenses" 
                        amount={totalExpenses} 
                        icon={ArrowDown} 
                    />
                </div>

                <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Transaction Form */}
                    <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl h-fit">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6 border-b pb-3">Record New Transaction</h2>
                        
                        <form onSubmit={addTransaction}>
                            {/* Type Toggle */}
                            <div className="flex space-x-2 mb-6 p-1 bg-gray-100 rounded-lg">
                                <button
                                    type="button"
                                    onClick={() => handleTypeChange('income')}
                                    className={`flex-1 py-2 rounded-lg font-semibold transition-all duration-200 ${
                                        newTransaction.type === 'income' ? 'bg-green-500 text-white shadow-md' : 'text-gray-600 hover:bg-white'
                                    }`}
                                >
                                    Income
                                </button>
                                <button
                                    type="button"
                                    onClick={() => handleTypeChange('expense')}
                                    className={`flex-1 py-2 rounded-lg font-semibold transition-all duration-200 ${
                                        newTransaction.type === 'expense' ? 'bg-red-500 text-white shadow-md' : 'text-gray-600 hover:bg-white'
                                    }`}
                                >
                                    Expense
                                </button>
                            </div>

                            {/* Amount Input */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center"><DollarSign className="w-4 h-4 mr-1" /> Amount ({currency.code})</label>
                                <input
                                    type="number"
                                    name="amount"
                                    value={newTransaction.amount}
                                    onChange={handleInputChange}
                                    step="0.01"
                                    placeholder={`e.g., 50.00 ${currency.symbol}`}
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            </div>

                            {/* Category/Source Select */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center"><Tag className="w-4 h-4 mr-1" /> Category</label>
                                <select
                                    name="category"
                                    value={newTransaction.category}
                                    onChange={handleInputChange}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                                >
                                    {CATEGORIES[newTransaction.type].map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Description Input */}
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center"><Clipboard className="w-4 h-4 mr-1" /> Description</label>
                                <input
                                    type="text"
                                    name="description"
                                    value={newTransaction.description}
                                    onChange={handleInputChange}
                                    placeholder={newTransaction.type === 'expense' ? 'e.g., Dinner at Italian Place' : 'e.g., Monthly Paycheck'}
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={!authReady}
                                className={`w-full py-3 rounded-xl font-bold text-white transition duration-300 ${
                                    !authReady ? 'bg-gray-400' : newTransaction.type === 'income' ? 'bg-green-600 hover:bg-green-700 shadow-md' : 'bg-red-600 hover:bg-red-700 shadow-md'
                                }`}
                            >
                                {newTransaction.type === 'income' ? 'Add Income' : 'Record Expense'}
                            </button>
                        </form>
                    </div>

                    {/* Transaction History */}
                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center border-b pb-3">
                            <Receipt className="w-6 h-6 mr-2 text-indigo-600" />
                            Transaction History
                        </h2>

                        {loading && (
                            <div className="flex justify-center items-center py-10 text-indigo-600">
                                <Loader2 className="w-6 h-6 animate-spin mr-2" />
                                Loading transactions...
                            </div>
                        )}
                        
                        {!loading && transactions.length === 0 && (
                            <div className="text-center py-10 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                                <p className="font-medium">No transactions yet!</p>
                                <p className="text-sm mt-1">Add your first income or expense to get started.</p>
                            </div>
                        )}

                        <div className="space-y-2">
                            {transactions.map(t => (
                                <TransactionItem
                                    key={t.id}
                                    type={t.type}
                                    amount={t.amount}
                                    description={t.description}
                                    category={t.category}
                                    timestamp={t.timestamp}
                                />
                            ))}
                        </div>
                    </div>
                </main>
            </div>
        </div>
    );
};

export default App;
